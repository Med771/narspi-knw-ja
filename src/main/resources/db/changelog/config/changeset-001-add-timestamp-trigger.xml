<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="create-trigger-set-timestamps-function" author="med">
        <comment>Универсальная функция триггера для timestamps</comment>

        <sql splitStatements="false" stripComments="false">
            <![CDATA[
            CREATE OR REPLACE FUNCTION trigger_set_timestamps()
            RETURNS TRIGGER
            LANGUAGE plpgsql
            AS $$
            BEGIN
                IF TG_OP = 'INSERT' THEN
                    NEW.created_at := COALESCE(NEW.created_at, NOW());
                    NEW.updated_at := NOW();
                    RETURN NEW;
                ELSIF TG_OP = 'UPDATE' THEN
                    NEW.updated_at := NOW();
                    RETURN NEW;
                END IF;
                RETURN NEW;
            END;
            $$;
            ]]>
        </sql>

        <rollback>
            <sql>DROP FUNCTION IF EXISTS trigger_set_timestamps() CASCADE;</sql>
        </rollback>
    </changeSet>

</databaseChangeLog>